name: Deploy Godot Game

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'

# å¿…é¡»æ·»åŠ æƒé™
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: éªŒè¯ Godot æ–‡ä»¶
        run: |
          echo "=== Godot æ¸¸æˆæ–‡ä»¶æ£€æŸ¥ ==="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo ""
          echo "docs æ–‡ä»¶å¤¹å†…å®¹:"
          ls -la docs/
          echo ""
          echo "æ£€æŸ¥å…³é”®æ–‡ä»¶..."
          REQUIRED_FILES=("index.html" "game.js" "game.wasm" "game.pck")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "docs/$file" ]; then
              echo "âœ… $file å­˜åœ¨"
            else
              echo "âš ï¸  $file ä¸å­˜åœ¨ (å¯èƒ½æ–‡ä»¶åä¸åŒ)"
            fi
          done
          
          # æŸ¥æ‰¾å®é™…çš„ wasm å’Œ pck æ–‡ä»¶å
          echo ""
          echo "æŸ¥æ‰¾ wasm æ–‡ä»¶:"
          find docs/ -name "*.wasm" -type f
          echo ""
          echo "æŸ¥æ‰¾ pck æ–‡ä»¶:"
          find docs/ -name "*.pck" -type f
      
      - name: åˆ›å»º .nojekyll æ–‡ä»¶ï¼ˆé‡è¦ï¼ï¼‰
        run: |
          # è¿™ä¸ªæ–‡ä»¶å‘Šè¯‰ GitHub Pages ä¸è¦ä½¿ç”¨ Jekyll å¤„ç†
          touch docs/.nojekyll
          echo "Created .nojekyll file"
      
      - name: ä¿®å¤æ–‡ä»¶æƒé™ï¼ˆå¦‚æœéœ€è¦ï¼‰
        run: |
          # ç¡®ä¿æ–‡ä»¶å¯è¯»
          chmod -R a+r docs/
      
      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          keep_files: false
          force_orphan: true  # æ¸…ç†æ—§æ–‡ä»¶
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ğŸ® Deploy Godot Game - $(date)'